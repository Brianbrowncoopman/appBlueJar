<ion-header class="ion-no-border">
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/home" text="Volver"></ion-back-button>
    </ion-buttons>
    <ion-title>Informes</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="descargarExcel()" [disabled]="ventasFiltradas.length === 0">
        <ion-icon slot="start" name="download-outline"></ion-icon>
        Excel
      </ion-button>
    </ion-buttons>
  </ion-toolbar>

  <ion-toolbar color="primary">
    <ion-segment [(ngModel)]="segmentoActivo" mode="md">
      <ion-segment-button value="ventas">
        <ion-label>VENTAS</ion-label>
      </ion-segment-button>
      <ion-segment-button value="comedor">
        <ion-label>COMEDOR</ion-label>
      </ion-segment-button>
    </ion-segment>
  </ion-toolbar>
</ion-header>

<ion-content class="gray-background">

  <div *ngIf="segmentoActivo === 'ventas'" class="ion-padding">
    
    <ion-item lines="none" class="filter-item" style="--background: #fff; border-radius: 10px; margin-bottom: 15px;">
      <ion-label>Mes de consulta:</ion-label>
      <ion-datetime-button datetime="dateFilter"></ion-datetime-button>
      <ion-modal [keepContentsMounted]="true">
        <ng-template>
          <ion-datetime 
            id="dateFilter" 
            presentation="month-year" 
            [(ngModel)]="fechaFiltro"
            (ionChange)="aplicarFiltro()">
          </ion-datetime>
        </ng-template>
      </ion-modal>
    </ion-item>

    <div class="informe-section">
      <h3 class="section-title">An√°lisis de Tendencia</h3>
      <ion-card class="analysis-card">
        <ion-card-content>
          <div style="height: 250px;">
            <canvas id="ventasChart"></canvas>
          </div>
          <div class="ion-text-center ion-padding-top">
            <ion-badge [color]="totalRealMensual >= totalMetaMensual ? 'success' : 'danger'" style="padding: 8px 15px; font-size: 1rem;">
              Cumplimiento: {{ (totalRealMensual / (totalMetaMensual || 1)) * 100 | number:'1.0-1' }}%
            </ion-badge>
          </div>
        </ion-card-content>
      </ion-card>
    </div>

    <div class="informe-section">
      <h3 class="section-title">Resumen del Mes</h3>
      <ion-card class="summary-card" style="background: #fff; border-left: 5px solid var(--ion-color-primary);">
        <ion-card-content>
          <ion-grid>
            <ion-row>
              <ion-col size="6">
                <small style="color: #666;">META TOTAL</small>
                <div style="font-size: 1.2rem; font-weight: bold;">${{ totalMetaMensual | number:'1.0-0' }}</div>
              </ion-col>
              <ion-col size="6">
                <small style="color: #666;">REAL TOTAL</small>
                <div style="font-size: 1.2rem; font-weight: bold;" [style.color]="totalRealMensual >= totalMetaMensual ? '#2ecc71' : '#e74c3c'">
                  ${{ totalRealMensual | number:'1.0-0' }}
                </div>
              </ion-col>
            </ion-row>
          </ion-grid>
        </ion-card-content>
      </ion-card>
    </div>

    <div class="informe-section">
      <h3 class="section-title">Detalle Diario</h3>
      <ion-card class="informe-card" *ngFor="let v of ventasFiltradas">
        <ion-card-content>
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <ion-badge color="dark">{{ v.fecha }}</ion-badge>
            <span [style.color]="v.diferencia >= 0 ? '#2ecc71' : '#e74c3c'" style="font-weight: bold;">
              {{ v.diferencia >= 0 ? '‚Üë Super√°vit' : '‚Üì D√©ficit' }}
            </span>
          </div>
          <ion-grid>
            <ion-row>
              <ion-col size="4"><small>META</small><div>${{ v.meta | number:'1.0-0' }}</div></ion-col>
              <ion-col size="4" class="ion-text-center"><small>REAL</small><div style="font-weight: 800; color: var(--ion-color-primary);">${{ v.real | number:'1.0-0' }}</div></ion-col>
              <ion-col size="4" class="ion-text-right"><small>DIF.</small><div [style.color]="v.diferencia >= 0 ? '#2ecc71' : '#e74c3c'">${{ v.diferencia | number:'1.0-0' }}</div></ion-col>
            </ion-row>
          </ion-grid>
        </ion-card-content>
      </ion-card>
    </div>
  </div>

  <div *ngIf="segmentoActivo === 'comedor'" class="ion-padding">
    <ion-accordion-group>
      <ion-accordion *ngFor="let item of historialComedor" [value]="item.fecha">
        <ion-item slot="header" color="light">
          <ion-label>
            <h2><strong>D√≠a: {{ item.fecha }}</strong></h2>
            <p>Plato: {{ item.minuta?.plato }}</p>
          </ion-label>
        </ion-item>
        <div class="ion-padding" slot="content">
          <ion-list>
            <ion-item>ü•ó Entrada: {{ item.minuta?.entrada }}</ion-item>
            <ion-item>üçΩÔ∏è Plato: {{ item.minuta?.plato }}</ion-item>
            <ion-list-header><ion-label>STOCK FINAL</ion-label></ion-list-header>
            <ion-item *ngFor="let entry of item.existencias | keyvalue">
              <ion-label>{{ asString(entry.key) | uppercase }}</ion-label>
              <ion-badge color="secondary" slot="end">{{ entry.value }}</ion-badge>
            </ion-item>
          </ion-list>
        </div>
      </ion-accordion>
    </ion-accordion-group>
  </div>

</ion-content>