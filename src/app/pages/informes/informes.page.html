

<ion-header class="ion-no-border">
  <ion-toolbar style="--background: #f4f1ea;">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/home" style="color: #1b365d;" text="Volver"></ion-back-button>
    </ion-buttons>
    <ion-title style="color: #1b365d; font-weight: 800; text-transform: uppercase;">Informes</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="descargarExcel()" style="--color: #1b365d; font-weight: 700;">
        <ion-icon slot="start" name="download-outline"></ion-icon>
        Excel
      </ion-button>
    </ion-buttons>
  </ion-toolbar>

  <ion-toolbar style="--background: #f4f1ea;">
    <ion-segment [(ngModel)]="segmentoActivo" mode="md" (ionChange)="aplicarFiltro()">
      <ion-segment-button value="ventas">
        <ion-label>VENTAS</ion-label>
      </ion-segment-button>
      <ion-segment-button value="comedor">
        <ion-label>COMEDOR</ion-label>
      </ion-segment-button>
      <ion-segment-button value="temperaturas">
        <ion-label>TEMPERATURAS</ion-label>
      </ion-segment-button>
      <ion-segment-button value="pedidos">
        <ion-label>PEDIDOS</ion-label>
      </ion-segment-button>

    </ion-segment>
  </ion-toolbar>
</ion-header>

<ion-content class="bj-content">
  <ng-container *ngIf="(authService.userProfile$ | async) as perfil; else loading">
    
    <div class="ion-padding main-container" *ngIf="perfil.rol === 'admin' || perfil.rol === 'supervisor'; else noAccess">
      
      <ion-item lines="none" class="filter-item" style="--background: #fff; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.05);">
        <ion-icon name="calendar-outline" slot="start" style="color: #1b365d;"></ion-icon>
        <ion-label style="font-weight: 700; color: #1b365d;">Periodo:</ion-label>
        <ion-datetime-button datetime="dateFilter"></ion-datetime-button>
        <ion-modal [keepContentsMounted]="true">
          <ng-template>
            <ion-datetime 
              id="dateFilter" 
              presentation="month-year" 
              [(ngModel)]="fechaFiltro" 
              (ionChange)="aplicarFiltro()">
            </ion-datetime>
          </ng-template>
        </ion-modal>
      </ion-item>

      <div *ngIf="segmentoActivo === 'ventas'">
        <div class="informe-section">
          <h3 class="section-title">Análisis de Tendencia</h3>
          <ion-card class="analysis-card">
            <ion-card-content>
              <div style="height: 250px; width: 100%; position: relative;">
                <canvas id="ventasChart"></canvas>
              </div>
            </ion-card-content>
          </ion-card>
        </div>

        <div class="informe-section">
          <h3 class="section-title">Resumen del Mes</h3>
          <ion-card class="summary-card-primary">
            <ion-grid>
              <ion-row>
                <ion-col size="6">
                  <small>META TOTAL</small>
                  <div class="total-monto">${{ totalMetaMensual | number:'1.0-0' }}</div>
                </ion-col>
                <ion-col size="6">
                  <small>REAL TOTAL</small>
                  <div class="total-monto" [style.color]="totalRealMensual >= totalMetaMensual ? '#2ecc71' : '#e74c3c'">
                    ${{ totalRealMensual | number:'1.0-0' }}
                  </div>
                </ion-col>
              </ion-row>
            </ion-grid>
          </ion-card>
        </div>

        <div class="informe-section">
          <h3 class="section-title">Detalle Diario</h3>
          <ion-card class="informe-card" *ngFor="let v of ventasFiltradas">
            <ion-card-content>
              <div class="venta-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <ion-badge style="--background: #1b365d;">{{ v.fecha }}</ion-badge>
                <div class="monto-diario" style="font-weight: 800; color: #1b365d; font-size: 1.1em;">${{ v.real | number:'1.0-0' }}</div>
              </div>
              <ion-grid class="ion-no-padding">
                <ion-row>
                  <ion-col size="6"><small style="color: #666;">META: ${{ v.meta | number:'1.0-0' }}</small></ion-col>
                  <ion-col size="6" class="ion-text-right">
                    <small [style.color]="v.diferencia >= 0 ? '#2ecc71' : '#e74c3c'" style="font-weight: 600;">
                      DIF: ${{ v.diferencia | number:'1.0-0' }}
                    </small>
                  </ion-col>
                </ion-row>
              </ion-grid>
            </ion-card-content>
          </ion-card>
        </div>
      </div>

      <div *ngIf="segmentoActivo === 'comedor'">
        <div class="informe-section">
          <h3 class="section-title">Flujo de Platos</h3>
          <ion-card class="analysis-card">
            <ion-card-content>
              <div style="height: 250px; width: 100%; position: relative;">
                <canvas id="comedorChart"></canvas>
              </div>
            </ion-card-content>
          </ion-card>
        </div>

        <div class="informe-section">
          <h3 class="section-title">Ranking de Existencias (Mes)</h3>
          <ion-card class="informe-card" style="border-radius: 15px; overflow: hidden;">
            <ion-list lines="full">
              <ion-item *ngFor="let item of totalesExistencias">
                <ion-label>
                  <h2 style="font-weight: 700; color: #1b365d; text-transform: capitalize;">{{ item.nombre }}</h2>
                  <p style="font-size: 0.8em; color: #888;">Consumo total acumulado</p>
                </ion-label>
                <ion-badge slot="end" style="--background: #1b365d; font-size: 14px; padding: 8px 12px; border-radius: 8px;">
                  {{ item.cantidad }}
                </ion-badge>
              </ion-item>
            </ion-list>
            <div *ngIf="totalesExistencias.length === 0" class="ion-padding ion-text-center">
              <ion-icon name="restaurant-outline" style="font-size: 40px; color: #ccc;"></ion-icon>
              <p style="color: #999;">No hay datos de comedor para este periodo.</p>
            </div>
          </ion-card>
        </div>
      </div>
      <!---->
      <div *ngIf="segmentoActivo === 'pedidos'">
        <div class="informe-section">
          <h3 class="section-title">Requerimientos de Insumos</h3>
          
          <div *ngIf="pedidosFiltrados.length === 0" class="ion-text-center ion-padding">
            <ion-icon name="cart-outline" style="font-size: 40px; color: #ccc;"></ion-icon>
            <p style="color: #999;">No hay pedidos registrados en este periodo.</p>
          </div>

          <ion-accordion-group>
            <ion-accordion *ngFor="let p of pedidosFiltrados" style="margin-bottom: 10px; border-radius: 15px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
              <ion-item slot="header" style="--background: #fff;">
                <ion-label>
                  <h2 style="font-weight: 800; color: #1b365d; text-transform: uppercase;">{{ p.area }}</h2>
                  <p style="color: #666;">Ver detalle de productos</p>
                </ion-label>
                <div slot="end" style="text-align: right; margin-right: 15px;">
                  <ion-badge color="primary" style="display: block; margin-bottom: 4px;">{{ p.fecha }}</ion-badge>
                  <small style="color: #999; font-weight: 600;">{{ p.hora }}</small>
                </div>
              </ion-item>

              <div slot="content" class="ion-padding" style="background: #fdfdfd;">
                <ion-list lines="none">
                  <ion-item *ngFor="let item of p.items" style="--min-height: 30px; border-bottom: 1px solid #f0f0f0;">
                    <ion-icon name="chevron-forward-outline" slot="start" size="small" color="primary"></ion-icon>
                    <ion-label style="font-size: 0.95em;">
                      <span style="font-weight: 800; color: #1b365d;">{{ item.cantidad }}</span> 
                      <span style="color: #444; margin-left: 10px;">{{ item.producto }}</span>
                    </ion-label>
                  </ion-item>
                </ion-list>
                
                <div *ngIf="p.observaciones" style="margin-top: 10px; padding: 10px; background: #fff4e6; border-radius: 8px; font-style: italic; border-left: 4px solid #ffd8a8;">
                  <small style="display:block; font-weight: bold; color: #d9480f;">OBSERVACIONES:</small>
                  {{ p.observaciones }}
                </div>
              </div>
            </ion-accordion>
          </ion-accordion-group>
        </div>
      </div>







      <!---->

      <div *ngIf="segmentoActivo === 'temperaturas'">
        <div class="informe-section">
          <h3 class="section-title">Control de Equipos (Cocina)</h3>
          <div *ngIf="tempsFiltradas.cocina.length === 0" class="ion-text-center ion-padding">
            <ion-icon name="thermometer-outline" style="font-size: 40px; color: #ccc;"></ion-icon>
            <p style="color: #999;">No hay registros de temperatura este mes.</p>
          </div>
          
          <div class="horizontal-scroll" style="display: flex; overflow-x: auto; padding-bottom: 10px;">
            <ion-card class="temp-report-card" *ngFor="let dia of tempsFiltradas.cocina" style="min-width: 280px; margin-right: 15px; border-radius: 15px;">
              <ion-card-header style="background: #1b365d; color: white; padding: 10px;">
                <ion-card-title style="font-size: 1rem; color: white; text-align: center;">{{ dia.fecha }}</ion-card-title>
              </ion-card-header>
              <ion-card-content class="ion-no-padding">
                <table class="temp-table" style="width: 100%; border-collapse: collapse; font-size: 0.85em;">
                  <thead>
                    <tr style="background: #f8f9fa;">
                      <th style="padding: 8px;">Eq.</th>
                      <th style="padding: 8px;">07:00</th>
                      <th style="padding: 8px;">14:00</th>
                      <th style="padding: 8px;">21:00</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let eq of $any(dia.equipos) | keyvalue" style="border-bottom: 1px solid #eee;">
                      <td style="padding: 8px; font-weight: 700; color: #1b365d;">
                        {{ asString(eq.key).replace('refri_', 'R.').replace('cong_', 'C.') }}
                      </td>
                      <td style="padding: 8px; text-align: center;" [style.color]="asNumber($any(eq.value)['07:00']) > 5 ? '#e74c3c' : '#2ecc71'">
                        {{ $any(eq.value)['07:00'] || '--' }}°
                      </td>
                      <td style="padding: 8px; text-align: center;" [style.color]="asNumber($any(eq.value)['14:00']) > 5 ? '#e74c3c' : '#2ecc71'">
                        {{ $any(eq.value)['14:00'] || '--' }}°
                      </td>
                      <td style="padding: 8px; text-align: center;" [style.color]="asNumber($any(eq.value)['21:00']) > 5 ? '#e74c3c' : '#2ecc71'">
                        {{ $any(eq.value)['21:00'] || '--' }}°
                      </td>
                    </tr>
                  </tbody>
                </table>
              </ion-card-content>
            </ion-card>
          </div>
        </div>
      </div>

    </div>

    <ng-template #noAccess>
      <div class="ion-text-center ion-padding" style="margin-top: 100px;">
        <ion-icon name="lock-closed-outline" style="font-size: 80px; color: #1b365d;"></ion-icon>
        <h2 style="font-weight: 800; color: #1b365d;">Acceso Restringido</h2>
        <p>Solo Administradores pueden ver los informes detallados.</p>
      </div>
    </ng-template>

  </ng-container>

  <ng-template #loading>
    <div class="ion-text-center ion-padding" style="margin-top: 50px;">
      <ion-spinner name="crescent" style="color: #1b365d;"></ion-spinner>
      <p style="color: #1b365d; font-weight: 600;">Cargando datos...</p>
    </div>
  </ng-template>
</ion-content>

<app-footer-brbc></app-footer-brbc>







<